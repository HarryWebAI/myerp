# 客户管理模块设计

### 简介

- 客户管理模块主要实现以下功能

  - 创建客户(restfull_create)
  - 展示客户列表(restfull_get)
  - 展示客户详情(restfull_get / ById)
  - 修改客户信息(restfull_update / ById)

    > 使用 drf.viewsets.ModelViewSet 实现去掉`delete`功能的视图集

  - 跟进客户(APIview / update)
  - 以客户为入口创建订单(暂时忽略, 待订单功能开发完毕)

### 目录结构

- 客户管理模块的后端位于: `~/myerp_backend/apps/client/`
  - `models.py` 存放客户模型, 跟进记录模型
  - `serializers.py` 存放客户模型序列化, 跟进记录序列化
  - `views.py` 存放客户模块功能接口 api
  - `urls.py` 封装客户模块路由
- 客户管理模块的前端涉及以下文件: `~/myerp_frontend/src` (依 Vue 编码规范以上路用`@`代替)
  - `@/views/client/`: 存放客户管理模块的视图 UI 文件, 包括:
    - `ClientList.vue` 客户列表
      - 创建客户功能在客户列表中
    - `ClientDetail.vue` 客户详情
      - 编辑客户功能
      - 跟进客户功能
      - 以客户为入口创建订单的功能(暂缓)
  - `@api/clientHttp.js`: 封装客户管理模块前端对后端发起请求的功能函数, 包括:
    - 请求当前员工名下所有的客户信息
    - 创建新的客户
    - 查看单个客户的详情
    - 修护单个客户信息
    - 跟进单个客户

### 模型设计

> 也就是数据表设计

1. 客户信息表
   - 客户姓名
   - 联系电话
   - 详细住址
   - 备注信息(可以给员工用来大致描述客户的信息)
   - 客户级别(分级: 1 级客户需要次日跟进, 2 级客户需要一周内跟进, 3 级客户需要一月内跟进, 4 级客户不需要跟进, 5 级客户已流失, 0 级客户已成交)
   - 最近一次跟进的时间(创建跟进记录时修改时间)
   - 最晚跟进时间(最近一次跟进的时间以及客户级别, 计算出客户下次最晚多久跟进)
   - 所属员工(外键 Staff, 绑定负责管理和跟进本客户的员工, N 个客户属于 1 个员工)
   - 跟进记录(1 个客户拥有 N 条跟进记录)
2. 跟进记录表
   - 跟进客户(外键)
   - 跟进员工(外键)
   - 跟进信息(输入当次客户跟进的信息)

### 工作流程
1. 客户列表:
    - 通过请求的用户(员工), 获取员工名下所有的客户, 以客户级别和最晚更新时间进行倒序排序(排除已流失和已成交的客户), 优先展示急需跟进的客户
    - 客户列表拥有客户详情接口: 点击可以进入客户详情
2. 客户详情:
    - 通过请求的用户(员工), 判断是否拥有访问此客户详情的权限, 如果没有则拒绝访问, 如果有, 则展示客户的全部信息
    - 跟进按钮: 点击可以创建跟进记录, 写入跟进信息, 修改客户分级, 通过客户分级锚定最晚跟进时间
    - 修改按钮: 点击可以将除客户分级和最晚跟进时间的信息解锁(变为input), 修改后可以提交.

### 权限管理部分
- 参考模型 Staff, 我将员工分为了4个级别:员工 < 仓库管理员 < 经理 < 老板
```python
is_staff = models.BooleanField(default=True)
is_boss = models.BooleanField(default=False)
is_manager = models.BooleanField(default=False)
is_storekeeper = models.BooleanField(default=False)
```
- 只有老板可以查看所有客户, 也可以编辑客户的所属员工

### 准备工作
- 为了测试权限, 应该先创建很多假员工数据, 请参考`~/myerp_backend/staff/management/commands/initsuperuser`, 才同级目录下创建 `initfakeusers` 文件, 创建几个数个普通员工, 一个经理, 两个仓库管理员.

### 后续工作
- 在开发完成后, 应该创建很多假客户数据, 请在`~/myerp_backend/client/management/commands/` 下根据`Client`模型的数据结构创建数条客户的假数据以供测试(不同的分级, 不同的最后跟进时间, 属于不同的假员工...)

